<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poster Status</title>
  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; padding:0; background:#0b0b0b; color:#f2f2f2; font: 15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .muted { color:#bdbdbd; }
    .card { background:#151515; border:1px solid #242424; border-radius: 14px; padding: 14px; margin: 12px 0; }
    .row { display:flex; gap:12px; flex-wrap: wrap; align-items:center; }
    label { display:flex; gap:8px; align-items:center; }
    input[type="number"] { width: 110px; padding: 6px 8px; border-radius: 10px; border:1px solid #2b2b2b; background:#0f0f0f; color:#fff; }
    button { padding: 8px 10px; border-radius: 10px; border:1px solid #2b2b2b; background:#0f0f0f; color:#fff; cursor:pointer; }
    button:hover { background:#141414; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding: 10px 8px; border-bottom: 1px solid #242424; vertical-align: top; }
    th { color:#cfcfcf; font-weight:600; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .right { text-align:right; }
    a { color:#9dd1ff; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid #2b2b2b; background:#0f0f0f; color:#eaeaea; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Poster status & timing</h1>

    <div class="card">
      <div class="row">
        <label>Seconds per poster
          <input id="posterSeconds" type="number" min="1" value="12">
        </label>
        <label>Fade (ms)
          <input id="fadeMs" type="number" min="0" value="900">
        </label>
        <label>Manifest refresh (sec)
          <input id="refreshSeconds" type="number" min="30" value="300">
        </label>

        <button id="applyBtn">Apply (download config)</button>
        <button id="refreshBtn">Refresh counts</button>

        <span id="info" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:10px;">
        Apply downloads <span class="mono">display-config.json</span>. Commit it to <span class="mono">assets/display-config.json</span>.
      </div>
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:10px;">Counts are based on <span class="mono">assets/films.json</span> and <span class="mono">assets/arrangements.json</span>.</div>
      <table>
        <thead>
          <tr>
            <th>Page</th>
            <th>What it shows</th>
            <th class="right">Count</th>
            <th class="right">Suggested duration</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <div class="row" style="gap:10px;">
        <a href="./films-portrait.html" target="_blank">films-portrait</a>
        <a href="./films-landscape.html" target="_blank">films-landscape</a>
        <a href="./arrangements-portrait.html" target="_blank">arrangements-portrait</a>
        <a href="./arrangements-landscape.html" target="_blank">arrangements-landscape</a>
        <a href="./portrait-all.html" target="_blank">portrait-all</a>
        <a href="./landscape-all.html" target="_blank">landscape-all</a>
      </div>
    </div>
  </div>

<script>
  const CONFIG_URL = "./assets/display-config.json";
  const FILMS_URL = "./assets/films.json";
  const ARR_URL   = "./assets/arrangements.json";

  function pill(t){ return `<span class="pill">${t}</span>`; }

  function fmtDuration(seconds) {
    seconds = Math.max(0, Math.round(seconds));
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${String(s).padStart(2,'0')}`;
  }

  async function fetchJson(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`${r.status} ${r.statusText} for ${url}`);
    return await r.json();
  }

  function downloadJson(filename, obj) {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function countField(items, field) {
    return (items || []).map(x => x?.[field]).filter(Boolean).length;
  }

  async function loadConfigIntoInputs() {
    try {
      const cfg = await fetchJson(CONFIG_URL);
      document.getElementById("posterSeconds").value = cfg.posterSeconds ?? 12;
      document.getElementById("fadeMs").value = cfg.fadeMs ?? 900;
      document.getElementById("refreshSeconds").value = cfg.manifestRefreshSeconds ?? 300;
      return cfg;
    } catch {
      return { posterSeconds: 12, fadeMs: 900, manifestRefreshSeconds: 300 };
    }
  }

  async function renderCounts() {
    const tbody = document.getElementById("tbody");
    const info = document.getElementById("info");
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;

    const posterSeconds = Number(document.getElementById("posterSeconds").value || 12);

    try {
      const [filmsData, arrData] = await Promise.all([fetchJson(FILMS_URL), fetchJson(ARR_URL)]);
      const films = filmsData.films || [];
      const arrs  = arrData.arrangements || [];

      const filmsPortrait = countField(films, "poster");
      const filmsLandscape= countField(films, "landscape");
      const arrPortrait   = countField(arrs, "poster");
      const arrLandscape  = countField(arrs, "landscape");

      const portraitAll = filmsPortrait + arrPortrait;
      const landscapeAll= filmsLandscape + arrLandscape;

      const rows = [
        { page:"films-portrait.html", desc:"Films portrait (poster)", count: filmsPortrait },
        { page:"films-landscape.html", desc:"Films landscape (subset)", count: filmsLandscape },
        { page:"arrangements-portrait.html", desc:"Arrangements portrait (poster)", count: arrPortrait },
        { page:"arrangements-landscape.html", desc:"Arrangements landscape (subset)", count: arrLandscape },
        { page:"portrait-all.html", desc:"Films then arrangements (portrait)", count: portraitAll },
        { page:"landscape-all.html", desc:"Films then arrangements (landscape subset)", count: landscapeAll }
      ];

      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${pill("ok")} <a href="./${r.page}" target="_blank">${r.page}</a></td>
          <td class="muted">${r.desc}</td>
          <td class="right mono">${r.count}</td>
          <td class="right mono">${fmtDuration(r.count * posterSeconds)}</td>
        </tr>
      `).join("");

      const u1 = filmsData.updated ? `films: ${filmsData.updated}` : `films: (no updated)`;
      const u2 = arrData.updated ? `arrangements: ${arrData.updated}` : `arrangements: (no updated)`;
      info.textContent = `${u1} | ${u2}`;
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="4">${pill("ERROR")} <span class="mono">${String(e.message || e)}</span></td></tr>`;
      info.textContent = "";
    }
  }

  document.getElementById("applyBtn").addEventListener("click", () => {
    const cfg = {
      posterSeconds: Number(document.getElementById("posterSeconds").value || 12),
      fadeMs: Number(document.getElementById("fadeMs").value || 900),
      manifestRefreshSeconds: Number(document.getElementById("refreshSeconds").value || 300)
    };
    downloadJson("display-config.json", cfg);
  });

  document.getElementById("refreshBtn").addEventListener("click", renderCounts);

  (async () => {
    await loadConfigIntoInputs();
    await renderCounts();
  })();
</script>
</body>
</html>
