<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portrait â€“ Films + Arrangements</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    .stage { position:relative; width:100%; height:100%; }
    .layer {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
      opacity:0;
      transition: opacity 900ms ease-in-out;
      will-change: opacity;
    }
    .layer.show { opacity:1; }
  </style>
</head>
<body>
  <div class="stage">
    <img id="a" class="layer show" alt="">
    <img id="b" class="layer" alt="">
  </div>

  <script>
    (async () => {
      const FILMS_MANIFEST = "./assets/films.json";
      const ARR_MANIFEST   = "./assets/arrangements.json";
      const FIELD = "poster";        // portrait only
      const SECONDS = 12;            // change timing here

      let urls = [];
      let i = 0;
      let frontIsA = true;
      let version = "";

      async function fetchJson(url) {
        const r = await fetch(url, { cache: "no-store" });
        return await r.json();
      }

      async function load() {
        const [filmsData, arrData] = await Promise.all([
          fetchJson(FILMS_MANIFEST),
          fetchJson(ARR_MANIFEST)
        ]);

        // use a combined cache-buster so new runs refresh images
        const u1 = filmsData.updated || "";
        const u2 = arrData.updated || "";
        version = (u1 || u2) ? ("?v=" + encodeURIComponent(u1 + "_" + u2)) : "";

        const films = (filmsData.films || []).map(x => x?.[FIELD]).filter(Boolean);
        const arrs  = (arrData.arrangements || []).map(x => x?.[FIELD]).filter(Boolean);

        // films first, then arrangements
        urls = films.concat(arrs);
        i = 0;
      }

      function swapTo(url) {
        const A = document.getElementById("a");
        const B = document.getElementById("b");
        const front = frontIsA ? A : B;
        const back  = frontIsA ? B : A;

        back.src = url + version;
        back.classList.add("show");
        front.classList.remove("show");
        frontIsA = !frontIsA;
      }

      async function preload(url) {
        await new Promise(resolve => {
          const img = new Image();
          img.onload = resolve;
          img.onerror = resolve;
          img.src = url + version;
        });
      }

      async function showNext() {
        if (!urls.length) return;
        const url = urls[i % urls.length];
        i += 1;
        await preload(url);
        swapTo(url);
      }

      await load();
      await showNext();

      setInterval(showNext, SECONDS * 1000);
      setInterval(async () => { try { await load(); } catch(e) {} }, 5 * 60 * 1000);
    })();
  </script>
</body>
</html>
