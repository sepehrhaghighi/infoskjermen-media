<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arrangements – Landscape</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }

    .stage{
      position:relative;
      width:100%;
      height:100%;
      z-index:1;
    }

    .layer{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      opacity:0;
      transition: opacity 900ms ease-in-out;
      will-change: opacity;
    }

    .layer.show{
      opacity:1;
    }

    #empty{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      color:#fff;
      background:#000;
      text-align:center;
      padding:40px;
      font:26px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      z-index:2000;
    }

    .qrWrap{
      position:fixed;
      right:20px;
      bottom:20px;
      z-index:1000;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
      pointer-events:none;

      opacity:0;
      transition: opacity 900ms ease-in-out;
      will-change: opacity;
    }

    .qrWrap.show{
      opacity:1;
    }

    .qrImg{
      width:146px;
      height:146px;
      object-fit:contain;
      background:rgba(255,255,255,0.97);
      padding:10px;
      border-radius:16px;
      box-shadow:
        0 14px 34px rgba(0,0,0,0.50),
        0 3px 10px rgba(0,0,0,0.30);
    }

    .qrText{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      color:#fff;
      background:rgba(0,0,0,0.74);
      padding:9px 14px;
      border-radius:14px;
      box-shadow:
        0 10px 24px rgba(0,0,0,0.38),
        0 2px 8px rgba(0,0,0,0.24);
      text-align:center;
      line-height:1.15;
      white-space:nowrap;
    }

    .qrMain{
      font:16px/1.15 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing:0.2px;
    }

    .qrSub{
      font:14px/1.15 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      opacity:0.95;
      letter-spacing:0.15px;
    }

    .dateLayer{
      position:fixed;
      left:22px;
      bottom:22px;
      z-index:900;
      opacity:0;
      transition: opacity 900ms ease-in-out;
      will-change: opacity;

      color:#fff;
      background:rgba(0,0,0,0.74);
      padding:10px 16px;
      border-radius:14px;
      box-shadow:
        0 10px 26px rgba(0,0,0,0.45),
        0 2px 8px rgba(0,0,0,0.28);

      font:24px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing:0.2px;
      pointer-events:none;
      white-space:nowrap;
      max-width:calc(100vw - 260px);
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .dateLayer.show{
      opacity:1;
    }
  </style>
</head>
<body>
  <div id="empty">No arrangement landscape posters available.</div>

  <div class="stage">
    <img id="a" class="layer show" alt="">
    <img id="b" class="layer" alt="">
  </div>

  <div id="qrWrap" class="qrWrap">
    <img id="qrImg" class="qrImg" src="./assets/QR.png" alt="QR code" onerror="this.style.opacity='0';">
    <div class="qrText">
      <div class="qrMain">Les mer - Kjøp billett</div>
      <div class="qrSub">www.amotkulturhus.no</div>
    </div>
  </div>

  <div id="dateA" class="dateLayer"></div>
  <div id="dateB" class="dateLayer"></div>

<script>
(async () => {
  const CONFIG_SERVICE_URL = "https://script.google.com/macros/s/AKfycbzfSFnMeg-26QNv802KVleuZWoEPqQE8zU4JwQLO3ikWL-fpYP4SFWTu8Q89jmgXq0YvQ/exec";
  const MANIFEST_URL = "./assets/arrangements.json";
  const FIELD = "landscape";

  let posterSeconds = 12;
  let fadeMs = 900;
  let refreshSeconds = 300;
  let refreshTimer = null;

  let items = []; // { url, date }
  let idx = 0;
  let frontIsA = true;
  let version = "";
  let qrShownOnce = false;

  const emptyEl = document.getElementById("empty");
  const A = document.getElementById("a");
  const B = document.getElementById("b");
  const dateA = document.getElementById("dateA");
  const dateB = document.getElementById("dateB");
  const qrWrap = document.getElementById("qrWrap");

  function numParam(name, fallback) {
    const v = new URLSearchParams(location.search).get(name);
    const n = Number(v);
    return Number.isFinite(n) && n > 0 ? n : fallback;
  }

  function parseDateParts(value) {
    if (!value) return null;

    const m = String(value).match(
      /^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/
    );
    if (!m) return null;

    return {
      year: Number(m[1]),
      month: Number(m[2]),
      day: Number(m[3]),
      hour: Number(m[4]),
      minute: Number(m[5]),
      second: Number(m[6] || 0)
    };
  }

  function formatArrangementDateTimeRange(begin, end) {
    const b = parseDateParts(begin);
    if (!b) return begin || "";

    const beginDate = new Date(b.year, b.month - 1, b.day, b.hour, b.minute, b.second);
    if (Number.isNaN(beginDate.getTime())) return begin || "";

    const dateText = new Intl.DateTimeFormat("nb-NO", {
      day: "numeric",
      month: "long",
      year: "numeric"
    }).format(beginDate);

    const beginTime = new Intl.DateTimeFormat("nb-NO", {
      hour: "2-digit",
      minute: "2-digit"
    }).format(beginDate);

    const e = parseDateParts(end);
    if (!e) {
      return `${dateText} kl. ${beginTime}`;
    }

    const endDate = new Date(e.year, e.month - 1, e.day, e.hour, e.minute, e.second);
    if (Number.isNaN(endDate.getTime())) {
      return `${dateText} kl. ${beginTime}`;
    }

    const endTime = new Intl.DateTimeFormat("nb-NO", {
      hour: "2-digit",
      minute: "2-digit"
    }).format(endDate);

    return `${dateText} kl. ${beginTime} - ${endTime}`;
  }

  async function fetchJson(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return await r.json();
  }

  function loadConfigJSONP(timeoutMs = 4000) {
    return new Promise((resolve) => {
      const cbName = "__cfgcb_" + Math.random().toString(16).slice(2);
      let done = false;

      window[cbName] = (cfg) => {
        done = true;
        cleanup();
        resolve(cfg || {});
      };

      const s = document.createElement("script");
      s.src = CONFIG_SERVICE_URL + "?callback=" + cbName + "&_=" + Date.now();
      s.onerror = () => { cleanup(); resolve({}); };
      document.head.appendChild(s);

      const t = setTimeout(() => {
        if (!done) { cleanup(); resolve({}); }
      }, timeoutMs);

      function cleanup() {
        clearTimeout(t);
        try { delete window[cbName]; } catch {}
        s.remove();
      }
    });
  }

  async function load() {
    const [cfg, data] = await Promise.all([
      loadConfigJSONP(),
      fetchJson(MANIFEST_URL)
    ]);

    posterSeconds  = numParam("p", cfg.posterSeconds ?? 12);
    fadeMs         = numParam("fade", cfg.fadeMs ?? 900);
    refreshSeconds = numParam("r", cfg.manifestRefreshSeconds ?? 300);

    A.style.transitionDuration = fadeMs + "ms";
    B.style.transitionDuration = fadeMs + "ms";
    dateA.style.transitionDuration = fadeMs + "ms";
    dateB.style.transitionDuration = fadeMs + "ms";
    if (qrWrap) qrWrap.style.transitionDuration = fadeMs + "ms";

    version = data.updated ? ("?v=" + encodeURIComponent(data.updated)) : "";

    const nextItems = (data.arrangements || [])
      .filter(x => x?.[FIELD])
      .map(x => ({
        url: x[FIELD],
        date: formatArrangementDateTimeRange(x.begin, x.end)
      }));

    const changed =
      nextItems.length !== items.length ||
      nextItems.some((it, i) =>
        it.url !== items[i]?.url ||
        it.date !== items[i]?.date
      );

    items = nextItems;
    if (changed) idx = 0;

    emptyEl.style.display = items.length ? "none" : "flex";
  }

  async function preload(item) {
    await new Promise(resolve => {
      const img = new Image();
      img.onload = resolve;
      img.onerror = resolve;
      img.src = item.url + version;
    });
  }

  function swapTo(item) {
    const frontImg  = frontIsA ? A : B;
    const backImg   = frontIsA ? B : A;
    const frontDate = frontIsA ? dateA : dateB;
    const backDate  = frontIsA ? dateB : dateA;

    backImg.src = item.url + version;

    const text = (item.date || "").trim();
    backDate.textContent = text;
    if (text) {
      backDate.classList.add("show");
    } else {
      backDate.classList.remove("show");
    }

    backImg.classList.add("show");
    frontImg.classList.remove("show");
    frontDate.classList.remove("show");

    if (!qrShownOnce && qrWrap) {
      qrWrap.classList.add("show");
      qrShownOnce = true;
    }

    frontIsA = !frontIsA;
  }

  async function tick() {
    if (!items.length) {
      setTimeout(tick, 2000);
      return;
    }

    const item = items[idx % items.length];
    idx += 1;

    await preload(item);
    swapTo(item);

    setTimeout(tick, posterSeconds * 1000);
  }

  function scheduleReload() {
    clearTimeout(refreshTimer);
    refreshTimer = setTimeout(async () => {
      try { await load(); } catch {}
      scheduleReload();
    }, refreshSeconds * 1000);
  }

  await load();
  tick();
  scheduleReload();
})();
</script>
</body>
</html>
