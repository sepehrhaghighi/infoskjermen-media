<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arrangements â€“ Landscape</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    .stage { position:relative; width:100%; height:100%; }

    .layer{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:contain; opacity:0;
      transition: opacity 900ms ease-in-out;
      will-change: opacity;
    }
    .layer.show { opacity:1; }

    #empty{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      color:#fff; background:#000; text-align:center; padding:40px;
      font:26px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    .qrWrap{
      position: fixed;
      right: 22px;
      bottom: 22px;
      z-index: 20;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }

    .qrWrap img{
      width: 122px;
      height: 122px;
      object-fit: contain;
      background: rgba(255,255,255,0.96);
      padding: 8px;
      border-radius: 14px;
      box-shadow:
        0 10px 26px rgba(0,0,0,0.45),
        0 2px 8px rgba(0,0,0,0.28);
    }

    .qrLabel{
      color: #fff;
      background: rgba(0,0,0,0.72);
      padding: 7px 12px;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.28);
      font: 15px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      white-space: nowrap;
      letter-spacing: 0.2px;
    }

    .dateBadge{
      position: fixed;
      left: 22px;
      bottom: 22px;
      z-index: 20;
      display: none;
      color:#fff;
      background: rgba(0,0,0,0.72);
      padding: 8px 14px;
      border-radius: 12px;
      box-shadow:
        0 10px 26px rgba(0,0,0,0.45),
        0 2px 8px rgba(0,0,0,0.28);
      font: 18px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      letter-spacing: 0.2px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="empty">No arrangement landscape posters available.</div>

  <div class="stage">
    <img id="a" class="layer show" alt="">
    <img id="b" class="layer" alt="">
  </div>

  <div id="qrWrap" class="qrWrap">
    <img
      src="./assets/QR.jpg"
      alt="QR code"
      onerror="window.__qrAvailable=false; document.getElementById('qrWrap').style.display='none';"
    >
    <div class="qrLabel">Read here / Buy here</div>
  </div>

  <div id="dateBadge" class="dateBadge"></div>

<script>
(async () => {
  const CONFIG_SERVICE_URL = "https://script.google.com/macros/s/AKfycbzfSFnMeg-26QNv802KVleuZWoEPqQE8zU4JwQLO3ikWL-fpYP4SFWTu8Q89jmgXq0YvQ/exec";
  const MANIFEST_URL = "./assets/arrangements.json";
  const FIELD = "landscape";

  window.__qrAvailable = true;

  let posterSeconds = 12;
  let fadeMs = 900;
  let refreshSeconds = 300;
  let qrEnabled = true;

  let refreshTimer = null;
  let configPollTimer = null;

  let items = []; // { url, date }
  let idx = 0;
  let frontIsA = true;
  let version = "";

  const emptyEl = document.getElementById("empty");
  const A = document.getElementById("a");
  const B = document.getElementById("b");
  const qrWrap = document.getElementById("qrWrap");
  const dateBadge = document.getElementById("dateBadge");

  function numParam(name, fallback) {
    const v = new URLSearchParams(location.search).get(name);
    const n = Number(v);
    return Number.isFinite(n) && n > 0 ? n : fallback;
  }

  function boolCfg(value, fallback = true) {
    if (value === undefined || value === null || value === "") return fallback;
    if (typeof value === "boolean") return value;
    const s = String(value).toLowerCase();
    if (s === "false" || s === "0" || s === "off" || s === "no") return false;
    return true;
  }

  function formatArrangementDate(begin) {
    if (!begin) return "";
    const d = new Date(String(begin).replace(" ", "T"));
    if (Number.isNaN(d.getTime())) return begin;

    return new Intl.DateTimeFormat("nb-NO", {
      day: "numeric",
      month: "long",
      year: "numeric"
    }).format(d);
  }

  async function fetchJson(url) {
    const r = await fetch(url, { cache: "no-store" });
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return await r.json();
  }

  function loadConfigJSONP(timeoutMs = 4000) {
    return new Promise((resolve) => {
      const cbName = "__cfgcb_" + Math.random().toString(16).slice(2);
      let done = false;

      window[cbName] = (cfg) => {
        done = true;
        cleanup();
        resolve(cfg || {});
      };

      const s = document.createElement("script");
      s.src = CONFIG_SERVICE_URL + "?callback=" + cbName + "&_=" + Date.now();
      s.onerror = () => { cleanup(); resolve({}); };
      document.head.appendChild(s);

      const t = setTimeout(() => {
        if (!done) { cleanup(); resolve({}); }
      }, timeoutMs);

      function cleanup() {
        clearTimeout(t);
        try { delete window[cbName]; } catch {}
        s.remove();
      }
    });
  }

  function applyQrUi() {
    if (!qrWrap) return;
    if (window.__qrAvailable === false || !qrEnabled) {
      qrWrap.style.display = "none";
      return;
    }
    qrWrap.style.display = "flex";
  }

  async function loadConfigOnly() {
    const cfg = await loadConfigJSONP();
    const prevRefresh = refreshSeconds;

    posterSeconds  = numParam("p", cfg.posterSeconds ?? 12);
    fadeMs         = numParam("fade", cfg.fadeMs ?? 900);
    refreshSeconds = numParam("r", cfg.manifestRefreshSeconds ?? 300);
    qrEnabled      = boolCfg(cfg.qrEnabled, true);

    A.style.transitionDuration = fadeMs + "ms";
    B.style.transitionDuration = fadeMs + "ms";

    applyQrUi();

    if (refreshSeconds !== prevRefresh) {
      scheduleReload();
    }
  }

  async function load() {
    const [_, data] = await Promise.all([
      loadConfigOnly(),
      fetchJson(MANIFEST_URL)
    ]);

    version = data.updated ? ("?v=" + encodeURIComponent(data.updated)) : "";

    const nextItems = (data.arrangements || [])
      .filter(x => x?.[FIELD])
      .map(x => ({
        url: x[FIELD],
        date: formatArrangementDate(x.begin)
      }));

    const changed =
      nextItems.length !== items.length ||
      nextItems.some((it, i) =>
        it.url !== items[i]?.url ||
        it.date !== items[i]?.date
      );

    items = nextItems;
    if (changed) idx = 0;

    emptyEl.style.display = items.length ? "none" : "flex";
  }

  async function preload(item) {
    await new Promise(resolve => {
      const img = new Image();
      img.onload = resolve;
      img.onerror = resolve;
      img.src = item.url + version;
    });
  }

  function swapTo(item) {
    if (dateBadge) {
      const text = (item.date || "").trim();
      if (text) {
        dateBadge.textContent = text;
        dateBadge.style.display = "block";
      } else {
        dateBadge.textContent = "";
        dateBadge.style.display = "none";
      }
    }

    const front = frontIsA ? A : B;
    const back  = frontIsA ? B : A;
    back.src = item.url + version;
    back.classList.add("show");
    front.classList.remove("show");
    frontIsA = !frontIsA;
  }

  async function tick() {
    if (!items.length) {
      setTimeout(tick, 2000);
      return;
    }

    const item = items[idx % items.length];
    idx += 1;
    await preload(item);
    swapTo(item);
    setTimeout(tick, posterSeconds * 1000);
  }

  function scheduleReload() {
    clearTimeout(refreshTimer);
    refreshTimer = setTimeout(async () => {
      try { await load(); } catch {}
      scheduleReload();
    }, refreshSeconds * 1000);
  }

  function scheduleConfigPoll() {
    clearTimeout(configPollTimer);
    configPollTimer = setTimeout(async () => {
      try { await loadConfigOnly(); } catch {}
      scheduleConfigPoll();
    }, 1000);
  }

  await load();
  tick();
  scheduleReload();
  scheduleConfigPoll();
})();
</script>
</body>
</html>
