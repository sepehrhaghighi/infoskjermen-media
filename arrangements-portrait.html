<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Arrangements â€“ Portrait</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }
    .stage { position:relative; width:100%; height:100%; }
    .layer {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:contain;
      opacity:0;
      transition: opacity 900ms ease-in-out;
      will-change: opacity;
    }
    .layer.show { opacity:1; }
  </style>
</head>
<body>
  <div class="stage">
    <img id="a" class="layer show" alt="">
    <img id="b" class="layer" alt="">
  </div>

  <script>
    (async () => {
      const MANIFEST = "./assets/arrangements.json";
      const FIELD = "poster";      // portrait
      const SECONDS = 12;
      const FADE_MS = 900;

      let urls = [];
      let i = 0;
      let version = "";
      let frontIsA = true;

      async function load() {
        const res = await fetch(MANIFEST, { cache: "no-store" });
        const data = await res.json();
        version = data.updated ? ("?v=" + encodeURIComponent(data.updated)) : "";
        const items = data.arrangements || [];
        urls = items.map(x => x?.[FIELD]).filter(Boolean);
        i = 0;
      }

      function swapTo(url) {
        const A = document.getElementById("a");
        const B = document.getElementById("b");
        const front = frontIsA ? A : B;
        const back  = frontIsA ? B : A;

        back.src = url + version;
        back.classList.add("show");
        front.classList.remove("show");
        frontIsA = !frontIsA;
      }

      async function preload(url) {
        await new Promise(resolve => {
          const img = new Image();
          img.onload = resolve;
          img.onerror = resolve;
          img.src = url + version;
        });
      }

      async function showNext() {
        if (!urls.length) return;
        const url = urls[i % urls.length];
        i += 1;
        await preload(url);
        swapTo(url);
      }

      await load();
      await showNext();

      setInterval(showNext, SECONDS * 1000);
      setInterval(async () => { try { await load(); } catch(e) {} }, 5 * 60 * 1000);
    })();
  </script>
</body>
</html>
